# Minoc - LLMエージェント 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名

Minoc（みのく）

### 1.2 目的

- LLMがPC操作を通じてプログラミングや執筆を行う
- ツール呼び出し履歴の収集と分析

### 1.3 概要

LLMが多様なツールを呼び出してPC操作を行い、その過程を記録するCLIアプリケーション。ユーザーは各ツール呼び出しに対して許可制御を行い、全ての操作履歴が記録される。

## 2. 機能要件

### 2.1 コア機能

#### 2.1.1 ツール呼び出し機能

- **コマンドライン操作**
  - シェルコマンドの実行
  - プロセス管理
  - 環境変数の操作

- **ファイル操作**
  - ファイル・ディレクトリの閲覧
  - テキストファイルの検索
  - ファイルの作成・編集・削除
  - パーミッション管理

- **開発支援**
  - プログラミング言語特有の操作
  - ビルド・テスト実行
  - パッケージ管理

#### 2.1.2 権限管理システム

- **ツール呼び出し許可機能**
  - 今回だけ許可：一度だけの実行許可
  - 永続的に許可：設定に保存し、今後自動承認
  - 拒否：実行を拒否

- **権限設定管理**
  - 永続許可設定の保存・読み込み
  - 権限レベルの調整
  - セキュリティポリシーの適用

- **セキュリティ制御**
  - 危険なコマンドのブロックリスト機能
    - システム削除系コマンド（`rm -rf`, `del /s`, `format`等）
    - ネットワーク系コマンド（ファイアウォール変更、ポート開放等）
    - 権限昇格コマンド（`sudo`, `runas`等）
    - システム設定変更コマンド（レジストリ変更、システムファイル変更等）
  - ブロックリストのカスタマイズ機能
  - 危険度レベル別の警告表示

#### 2.1.3 履歴管理機能

- **セッション記録**
  - システムプロンプトの保存
  - ツール呼び出し履歴の記録
  - LLMの入出力ログ
  - エラー・例外の記録

#### 2.1.4 エラーハンドリング・復旧機能

- **API呼び出し失敗時のリトライ機構**
  - 指数バックオフによるリトライ（1秒、2秒、4秒、8秒...）
  - 最大リトライ回数の設定（デフォルト：3回）
  - リトライ対象エラーの分類
    - ネットワークエラー
    - レート制限エラー（HTTP 429）
    - 一時的なサーバーエラー（HTTP 5xx）
  - リトライ除外エラー（認証失敗、不正なリクエスト等）
- **自動復旧とフォールバック**
  - 部分的な処理継続機能
  - 代替処理パスの実行
  - セッション状態の保存・復元

#### 2.1.5 プログレスバー・進捗表示機能

- **長時間処理時の進捗表示**
  - アニメーション付きプログレスバー
  - 現在実行中のタスク名表示
  - 経過時間・推定残り時間の表示
- **進捗表示の制御**
  - 5秒以上の処理で自動表示
  - ユーザーによる進捗表示の有効/無効切り替え
  - 静かモード（プログレスバー非表示）の提供

### 2.2 LLM統合機能

#### 2.2.1 API接続

- **OpenAI SDK ChatCompletion**を使用
- OpenAI互換APIサポート
- ストリーミング応答対応

#### 2.2.2 設定可能パラメータ

- **接続設定**
  - ベースURL
  - APIキー
  - モデル名

- **生成パラメータ**
  - temperature
  - top_p
  - top_k
  - max_tokens

#### 2.2.3 システムプロンプト構成

- **共通システムプロンプト（固定）**
  - ツール呼び出し形式の説明
  - セキュリティガイドライン
  - 基本的な動作ルール
  - XMLツール呼び出しの使用方法
  - アプリケーション固有の制約事項
  - ハードコードされており変更不可

- **カスタムインストラクション（設定可能）**
  - モデルごとの個別設定
  - ユーザー定義の追加指示
  - タスク固有のガイドライン
  - 出力スタイルの調整

- **最終システムプロンプト**
  - 共通システムプロンプト + カスタムインストラクション
  - 結合時の優先順位は共通プロンプトが最上位

#### 2.2.4 デバッグモード機能

- **詳細ログ出力**
  - すべてのツール呼び出しの詳細ログ
  - LLM API リクエスト・レスポンスの完全ログ
  - 内部状態の変化ログ
  - パフォーマンス計測情報
- **ドライラン機能**
  - ツール実行のシミュレーション
  - 実際の操作を行わずに処理フローを確認
  - 権限チェックと承認プロセスの検証
- **ステップ実行機能**
  - 1つずつツール呼び出しを確認しながら実行
  - 各ステップでの一時停止・継続選択
  - 途中での処理中断・変更機能

#### 2.2.5 ツール呼び出し形式

- **XML形式**でのツール定義
- 参考実装：
  - https://zenn.dev/minedia/articles/11822c2b509a79
  - https://github.com/cline/cline
    **注意:** LLMからのツール呼び出しは同時に1つまでとし、複数ツールの並列実行は許可しない。

##### XML形式の基本スキーマ

```xml
<tool_call>
<tool_name>
<parameter1_name>value1</parameter1_name>
<parameter2_name>value2</parameter2_name>
</tool_name>
</tool_call>
```

##### 具体的なツール定義例

````xml
**ファイル読み込みツール**
```xml
<tool_call>
<read_file>
<path>src/main.ts</path>
</read_file>
</tool_call>
````

**複数ファイル読み込みツール**

```xml
<tool_call>
<read_files>
<paths>
  <path>src/main.ts</path>
  <path>src/utils.ts</path>
  <path>src/config.ts</path>
</paths>
</read_files>
</tool_call>
```

**ファイル書き込みツール**

```xml
<tool_call>
<write_to_file>
<path>config.json</path>
<content>
{
  "apiKey": "secret",
  "debug": true
}
</content>
</write_to_file>
</tool_call>
```

**コマンド実行ツール**

```xml
<tool_call>
<execute_command>
<command>npm install</command>
<requires_approval>false</requires_approval>
</execute_command>
</tool_call>
```

**ディレクトリ作成ツール**

```xml
<tool_call>
<create_directory>
<path>src/components</path>
</create_directory>
</tool_call>
```

**ファイル検索ツール**

```xml
<tool_call>
<search_files>
<pattern>*.ts</pattern>
<directory>src</directory>
</search_files>
</tool_call>
```

## 3. システム設計

### 3.1 アーキテクチャ

#### 3.1.1 モジュール分割

```
Minoc/
├── core/           # 基幹部分
│   ├── llm/        # LLM統合
│   ├── tools/      # ツール定義・実行
│   ├── history/    # 履歴管理
│   ├── config/     # 設定管理
│   └── permission/      # 権限管理
├── cli/            # CLI インターフェース
│   ├── commands/   # CLIコマンド
│   ├── ui/         # ユーザーインターフェース
│   └── prompt/     # プロンプト処理
└── interfaces/     # 共通インターフェース
    ├── agent.ts    # エージェント基底クラス
    ├── tool.ts     # ツール基底インターフェース
    └── history.ts  # 履歴形式定義
```

#### 3.1.2 主要クラス設計

- **Agent**: LLMエージェントの基底クラス
- **ToolExecutor**: ツール実行管理
- **PermissionManager**: 権限管理
- **HistoryRecorder**: 履歴記録
- **ConfigManager**: 設定管理
- **SecurityManager**: セキュリティ制御・ブロックリスト管理
- **RetryManager**: API呼び出しリトライ制御
- **ProgressManager**: 進捗表示管理
- **DebugManager**: デバッグ機能制御

### 3.2 データ管理

#### 3.2.1 ディレクトリ構造

```
実行ファイルと同階層/
├── .minoc/
│   ├── config/
│   │   ├── settings.json       # 基本設定
│   │   ├── permissions.json    # 権限設定
│   │   ├── models.json         # モデル設定（カスタムインストラクション含む）
│   │   ├── security.json       # セキュリティ設定・ブロックリスト
│   │   └── debug.json          # デバッグモード設定
│   ├── history/
│   │   └── sessions/           # セッション履歴
│   │       └── YYYY-MM-DD/
│   │           └── session_ID.json
│   └── logs/
│       ├── app.log            # アプリケーションログ
│       ├── error.log          # エラーログ
│       ├── debug.log          # デバッグログ
│       └── retry.log          # リトライ処理ログ
```

**注意事項:**

- 全ての設定ファイルと履歴は実行ファイルと同じ階層の `.minoc` ディレクトリに保存される
- 異なる階層で実行される場合でも、常に実行ファイルの場所を基準とする

#### 3.2.2 履歴データ形式

```json
{
  "sessionId": "uuid",
  "timestamp": "2024-01-01T00:00:00Z",
  "model": "gpt-4",
  "systemPrompt": "...",
  "messages": [
    {
      "role": "user|assistant|system|tool_call|tool_response",
      "content": "...",
      "timestamp": "..."
    }
  ],
  "metadata": {
    "totalTokens": 1000,
    "duration": 300
  }
}
```

## 4. 技術仕様

### 4.1 開発環境

- **言語**: Deno (TypeScript)
- **ランタイム**: Deno 2.4.0
- **依存関係管理**: deno.json

### 4.2 主要ライブラリ

- **LLM統合**: OpenAI SDK
- **CLI**: @cliffy/command
- **ファイル操作**: Deno標準ライブラリ
- **ログ**: @std/log
- **設定管理**: @std/json

### 4.3 システムプロンプト仕様

- **共通システムプロンプト（ハードコード）**
  - アプリケーション内に固定で実装
  - XMLツール呼び出し形式の定義
  - セキュリティ制約とガイドライン
  - 基本動作ルールとエラーハンドリング指示
  - 変更不可の重要な制約事項

- **カスタムインストラクション**
  - `models.json`でモデルごとに設定
  - ユーザーがカスタマイズ可能
  - タスクやワークフロー固有の指示
  - 出力形式や動作スタイルの調整

- **結合ルール**
  - 最終プロンプト = 共通システムプロンプト + "\n\n" + カスタムインストラクション
  - 共通プロンプトが優先され、カスタムインストラクションで上書き不可

### 4.4 外部API

- OpenAI API (または互換API)
- モデルプロバイダーAPI

## 5. 開発計画

### 5.1 Phase 1: 基盤構築

- [ ] プロジェクト構造の作成
- [ ] Coreモジュールの基本実装
- [ ] 設定管理システム
- [ ] 基本的なツール定義

### 5.2 Phase 2: CLI実装

- [ ] CLIインターフェースの構築
- [ ] 権限管理システム
- [ ] 基本的なツール実行機能

### 5.3 Phase 3: LLM統合

- [ ] OpenAI SDK統合
- [ ] ツール呼び出しXML解析
- [ ] 応答処理とエラーハンドリング

### 5.4 Phase 4: 履歴機能

- [ ] セッション履歴記録
- [ ] 履歴データの構造化
