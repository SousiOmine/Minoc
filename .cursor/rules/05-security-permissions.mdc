# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨æ¨©é™ç®¡ç†

Minocã§ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã®è¨­è¨ˆåŸå‰‡ã«åŸºã¥ã„ã¦ã€å…¨ã¦ã®ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œã«å¯¾ã—ã¦å³æ ¼ãªæ¨©é™ç®¡ç†ã¨æ‰¿èªã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- [PermissionManager](mdc:core/permission/permission_manager.ts) - æ¨©é™ç®¡ç†
- [SecurityManager](mdc:core/permission/security_manager.ts) - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ç®¡ç†
- [ApprovalManager](mdc:cli/ui/approval.ts) - ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªUI

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«

1. **å³æ ¼ï¼ˆstrictï¼‰** - å…¨ã¦ã®å±é™ºãªæ“ä½œã«æ‰¿èªãŒå¿…è¦
2. **é€šå¸¸ï¼ˆnormalï¼‰** - æ¨™æº–çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«
3. **å¯›å®¹ï¼ˆpermissiveï¼‰** - ä¸€éƒ¨ã®å®‰å…¨ãªæ“ä½œã¯è‡ªå‹•æ‰¿èª

## ãƒ„ãƒ¼ãƒ«ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†é¡

### å®‰å…¨ãªãƒ„ãƒ¼ãƒ«ï¼ˆdangerous: falseï¼‰
```typescript
export class ReadFileTool extends BaseTool {
  override readonly dangerous = false;
  override readonly requiresApproval = false;
  // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã¯åŸºæœ¬çš„ã«å®‰å…¨
}
```

### å±é™ºãªãƒ„ãƒ¼ãƒ«ï¼ˆdangerous: trueï¼‰
```typescript
export class WriteToFileTool extends BaseTool {
  override readonly dangerous = true;
  override readonly requiresApproval = true;
  // ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿ã¯å±é™ºãªæ“ä½œ
}
```

### è¶…å±é™ºãªãƒ„ãƒ¼ãƒ«ï¼ˆè¦æ‰¿èªï¼‰
```typescript
export class ExecuteCommandTool extends BaseTool {
  override readonly dangerous = true;
  override readonly requiresApproval = true;
  // ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã¯å¸¸ã«æ‰¿èªãŒå¿…è¦
}
```

## æ¨©é™ç®¡ç†ãƒ•ãƒ­ãƒ¼

### 1. æ¨©é™ãƒã‚§ãƒƒã‚¯
```typescript
const permissionResult = await this.toolExecutor.checkPermission(toolCall);
if (!permissionResult.allowed) {
  console.log(`âŒ ãƒ„ãƒ¼ãƒ«å®Ÿè¡ŒãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ: ${permissionResult.reason}`);
  return;
}
```

### 2. æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹
```typescript
if (permissionResult.requiresApproval) {
  const approval = await this.approvalManager.requestApproval(toolCall, permissionResult);
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠã«åŸºã¥ãå‡¦ç†
  switch (approval.choice) {
    case 'allow_once': // ä»Šå›ã ã‘è¨±å¯
    case 'allow_always': // æ°¸ç¶šçš„ã«è¨±å¯
    case 'deny': // ä»Šå›æ‹’å¦
    case 'deny_always': // æ°¸ç¶šçš„ã«æ‹’å¦
  }
}
```

### 3. æ¨©é™è¨­å®šã®æ°¸ç¶šåŒ–
```typescript
// æ°¸ç¶šè¨±å¯
await permissionManager.addToPermanentlyAllowed(toolCall.toolName);

// æ°¸ç¶šæ‹’å¦
await permissionManager.addToAutoReject(toolCall.toolName);
```

## ãƒ–ãƒ­ãƒƒã‚¯ãƒªã‚¹ãƒˆæ©Ÿèƒ½

### å±é™ºãªã‚³ãƒãƒ³ãƒ‰ã®è‡ªå‹•ãƒ–ãƒ­ãƒƒã‚¯
```typescript
const blockedCommands = [
  'rm -rf',        // ãƒ•ã‚¡ã‚¤ãƒ«å…¨å‰Šé™¤
  'del /s',        // Windows ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
  'format',        // ãƒ‡ã‚£ã‚¹ã‚¯ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
  'sudo rm',       // ç®¡ç†è€…æ¨©é™ã§ã®ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
  'chmod 777',     // æ¨©é™ã‚’å…¨é–‹æ”¾
  // ...ãã®ä»–å±é™ºãªã‚³ãƒãƒ³ãƒ‰
];
```

### ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ãªãƒ–ãƒ­ãƒƒã‚¯ãƒªã‚¹ãƒˆ
```toml
# security.toml
blockedCommands = [
  "rm -rf",
  "del /s", 
  "format",
  "sudo",
  "your-custom-blocked-command"
]

permissionLevel = "strict"
```

## æ‰¿èªUIãƒ‘ã‚¿ãƒ¼ãƒ³

### ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªæ‰¿èª
```
ğŸ”§ ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—: execute_command
âš ï¸  å±é™ºãªæ“ä½œã§ã™: ã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œ

å®Ÿè¡Œäºˆå®šã®ã‚³ãƒãƒ³ãƒ‰:
> npm install express

ã“ã®ãƒ„ãƒ¼ãƒ«ã®å®Ÿè¡Œã‚’è¨±å¯ã—ã¾ã™ã‹ï¼Ÿ
1. ä»Šå›ã ã‘è¨±å¯ (o)
2. æ°¸ç¶šçš„ã«è¨±å¯ (a) 
3. æ‹’å¦ (n)
4. æ°¸ç¶šçš„ã«æ‹’å¦ (d)

é¸æŠã—ã¦ãã ã•ã„ [o/a/n/d]: 
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Šã®è¡¨ç¤º
```typescript
console.log('âš ï¸  å±é™ºãªæ“ä½œã§ã™: ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®å¤‰æ›´');
console.log('ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯: ã‚³ãƒãƒ³ãƒ‰ã«ãƒ–ãƒ­ãƒƒã‚¯ãƒªã‚¹ãƒˆã®é …ç›®ãŒå«ã¾ã‚Œã¦ã„ã¾ã™');
console.log('ğŸ›¡ï¸  å®‰å…¨æ€§ç¢ºèª: ã“ã®æ“ä½œã‚’æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ');
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### å…¥åŠ›å€¤ã®æ¤œè¨¼
```typescript
// ãƒ‘ã‚¹ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
const safePath = path.resolve(path.normalize(userInput));
if (!safePath.startsWith(allowedDirectory)) {
  throw new Error('è¨±å¯ã•ã‚Œã¦ã„ãªã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã§ã™');
}

// ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–
const sanitizedCommand = command.replace(/[;&|`$(){}[\]]/g, '');
```

### ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
```typescript
// èª­ã¿è¾¼ã¿æ¨©é™ãƒã‚§ãƒƒã‚¯
const stat = await Deno.stat(filePath);
if (!stat.isFile) {
  return this.error('ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
}

// æ›¸ãè¾¼ã¿æ¨©é™ãƒã‚§ãƒƒã‚¯
try {
  await Deno.writeTextFile(filePath, content);
} catch (error) {
  if (error instanceof Deno.errors.PermissionDenied) {
    return this.error('ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
  }
}
```

### ç’°å¢ƒå¤‰æ•°ã®å®‰å…¨ãªå–ã‚Šæ‰±ã„
```typescript
// æ©Ÿå¯†æƒ…å ±ã‚’å«ã‚€å¯èƒ½æ€§ã®ã‚ã‚‹ç’°å¢ƒå¤‰æ•°ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
const safeEnvironment = Object.fromEntries(
  Object.entries(Deno.env.toObject()).filter(([key]) => 
    !key.toLowerCase().includes('key') && 
    !key.toLowerCase().includes('token') &&
    !key.toLowerCase().includes('secret')
  )
);
```

## å±¥æ­´ã¨ãƒ­ã‚°

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã®è¨˜éŒ²
```typescript
await this.historyRecorder.recordSecurityEvent(sessionId, {
  event: 'permission_denied',
  toolName: toolCall.toolName,
  reason: permissionResult.reason,
  timestamp: new Date().toISOString(),
});
```

### ç›£æŸ»ãƒ­ã‚°
å…¨ã¦ã®ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã¯å±¥æ­´ã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã€å¾Œã‹ã‚‰ç›£æŸ»å¯èƒ½ã§ã™ã€‚
description:
globs:
alwaysApply: false
---
